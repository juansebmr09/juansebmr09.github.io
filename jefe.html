<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Jefe - Reclamaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .pagination-btn.active { background-color: #1e40af; color: white; border-color: #1e40af; }
        .disabled-link { pointer-events: none; opacity: 0.5; background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col font-inter">

    <header class="relative w-full bg-[#007cc3] shadow-md z-20">
        <img src="OVA Header Jefe.png" alt="Header Corporativo" class="w-full h-auto object-cover block min-h-[50px] max-h-[80px]">
    </header>

    <main class="flex-grow p-6 flex flex-col max-w-[1600px] mx-auto w-full">
        
        <div id="viewDashboard" class="flex flex-col w-full fade-in">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Bandeja de Aprobaci√≥n</h1>
                <p class="text-sm text-gray-500">Gestionar la solicitudes de reclamaciones asignadas.</p>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"> <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Estado</label>
                        <select id="filter_status" class="w-full border-gray-300 rounded-md text-sm bg-gray-50 focus:ring-blue-500">
                            <option value="">Todos</option>
                            <option value="Pendiente" selected>Pendiente</option> <option value="Devoluci√≥n">Devoluci√≥n</option> <option value="Pendiente Gesti√≥n Humana">Pendiente Gesti√≥n Humana</option>
                            <option value="Aprobado">Aprobado</option>
                            <option value="Rechazado">Rechazado</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">No. Solicitud</label>
                        <input type="text" id="filter_reqId" class="w-full border-gray-300 rounded-md text-sm focus:ring-blue-500" placeholder="Ej: 4521...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">C√≥d. Asesor</label>
                        <input type="text" id="filter_advisorCode" class="w-full border-gray-300 rounded-md text-sm focus:ring-blue-500" placeholder="Ej: 4521">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fecha de creaci√≥n</label>
                        <div class="flex items-center border border-gray-300 rounded-md bg-white overflow-hidden focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500">
                            <input type="date" id="filter_dateFrom" class="w-full border-none text-sm focus:ring-0 text-gray-600 p-2 outline-none" placeholder="Desde">
                            <span class="text-gray-400 font-bold px-1">‚Üí</span>
                            <input type="date" id="filter_dateTo" class="w-full border-none text-sm focus:ring-0 text-gray-600 p-2 outline-none" placeholder="Hasta">
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-end gap-3 border-t pt-4 border-gray-100">
                    <button onclick="clearFilters()" class="text-gray-500 hover:text-gray-700 text-sm font-medium px-4 py-2">Limpiar Filtros</button>
                    <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded shadow flex items-center gap-2 transition">
                        Exportar Excel
                    </button>
                    <button onclick="applyFilters()" class="bg-blue-700 hover:bg-blue-800 text-white text-sm font-bold py-2 px-6 rounded shadow-sm transition">CONSULTAR</button>
                </div>
            </div>


            <div class="bg-white border border-gray-200 rounded-lg shadow-sm mb-10">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Fecha Creaci√≥n</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">No. Solicitud</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">C√≥d. Asesor</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Nombre Asesor</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Asignado A</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">√öltima Gesti√≥n</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
                <div class="bg-gray-50 px-6 py-3 border-t border-gray-200 flex items-center justify-between rounded-b-lg">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600">Mostrar</span>
                        <select id="itemsPerPage" onchange="changePageSize()" class="border-gray-300 rounded text-sm py-1 bg-white focus:ring-blue-500">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                        </select>
                        <span class="text-sm text-gray-600">por p√°gina</span>
                    </div>
                    <div class="flex items-center gap-2" id="paginationControls"></div>
                </div>
            </div>
        </div>

        <div id="viewDetail" class="hidden flex-col w-full fade-in pb-20">
            <div class="mb-4">
                <button onclick="showDashboard()" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 text-sm bg-white px-3 py-1 rounded border border-blue-100 shadow-sm transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Volver a la bandeja
                </button>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-5 mb-6 shadow-sm relative">
                <button onclick="showAttachments()" class="absolute top-4 right-4 bg-white hover:bg-blue-50 text-blue-700 border border-blue-200 font-bold py-1.5 px-3 rounded shadow-sm text-xs flex items-center gap-2 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
                    Ver Adjuntos (1)
                </button>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6 text-sm mt-1">
                    <div class="flex flex-col border-r border-blue-200 pr-4">
                        <span class="text-gray-500 text-xs uppercase font-bold tracking-wider mb-1">No. Solicitud</span>
                        <span id="detail_reqId" class="font-bold text-blue-700 text-lg">---</span>
                    </div>
                    <div class="flex flex-col border-r border-blue-200 pr-4">
                        <span class="text-gray-500 text-xs uppercase font-bold tracking-wider mb-1">C√≥digo Asesor</span>
                        <span id="detail_advCode" class="font-semibold text-gray-800">---</span>
                    </div>
                    <div class="flex flex-col border-r border-blue-200 pr-4">
                        <span class="text-gray-500 text-xs uppercase font-bold tracking-wider mb-1">C√©dula Asesor</span>
                        <span id="detail_advId" class="font-semibold text-gray-800">---</span>
                    </div>
                    <div class="flex flex-col border-r border-blue-200 pr-4">
                        <span class="text-gray-500 text-xs uppercase font-bold tracking-wider mb-1">Nombre Asesor</span>
                        <span id="detail_advName" class="font-semibold text-gray-800">---</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-gray-500 text-xs uppercase font-bold tracking-wider mb-1">Fecha Solicitud</span>
                        <span id="detail_date" class="font-semibold text-gray-800">---</span>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg shadow-sm mb-6">
                <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700">Registros de la reclamaci√≥n</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-[#eeeeee]">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-black uppercase border-r border-gray-300 min-w-[150px]">Tipo Novedad</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-black uppercase border-r border-gray-300">Plan</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-black uppercase border-r border-gray-300">Programa</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-black uppercase border-r border-gray-300">Contrato</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-black uppercase border-r border-gray-300">Usuario</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-black uppercase border-r border-gray-300 min-w-[150px]">Motivo (Asesor)</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-black uppercase min-w-[150px] bg-blue-50 border-l border-blue-100">Respuesta Jefe</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-black uppercase min-w-[100px] bg-blue-50">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="detailsBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="flex justify-end" id="btnFinishContainer">
                <button id="btnFinishManagement" onclick="finishManagement()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded shadow-lg transition flex items-center gap-2 transform hover:-translate-y-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    Finalizar Gesti√≥n de Solicitud
                </button>
            </div>
        </div>

    </main>

    <div id="responseModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto w-[95%] max-w-lg bg-white shadow-2xl rounded-xl animate-[fade-in_0.2s_ease-out] overflow-hidden">
            <div id="modalHeader" class="bg-blue-600 px-6 py-4 flex justify-between items-center transition-colors">
                <h3 id="modalTitle" class="text-lg font-bold text-white">Responder Reclamaci√≥n</h3>
                <button onclick="closeResponseModal()" class="text-white hover:text-gray-200"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            
            <div class="p-6">
                <input type="hidden" id="modal_rowId">
                <input type="hidden" id="modal_reqId">

                <div class="mb-5">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Tipo de Novedad (Correcci√≥n)</label>
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <input type="text" id="modal_novedad_display" class="w-full border-gray-300 bg-gray-100 text-gray-500 rounded-md py-2 px-3 text-sm cursor-not-allowed" disabled>
                            
                            <select id="modal_novedad_select" class="hidden w-full border-blue-500 bg-white text-gray-800 rounded-md py-2 px-3 text-sm focus:ring-blue-500">
                                <option value="CSC - Comision por cuota">CSC - Comision por cuota</option>
                                <option value="CQC - Comision por cuota negocios estrategicos">CQC - Comision por cuota negocios estrategicos</option>
                                <option value="ACP - Acelerador ORO PLUS">ACP - Acelerador ORO PLUS</option>
                                <option value="Comisi√≥n errada">Comisi√≥n errada</option>
                            </select>
                        </div>
                        <button id="btnEditNovedad" onclick="toggleNovedadEdit()" class="bg-amber-100 hover:bg-amber-200 text-amber-700 border border-amber-300 p-2 rounded transition" title="Editar tipo de novedad">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                    </div>
                </div>

                <div class="mb-5">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Respuesta <span id="req_respuesta_asterisk" class="text-red-500">*</span></label>
                    <select id="modal_respuesta" onchange="toggleJustification()" class="w-full border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="">Seleccione...</option>
                        <option value="Aprobada">Aprobada</option>
                        <option value="Rechazada">Rechazada</option>
                        <option value="Devoluci√≥n">Devoluci√≥n</option>
                    </select>
                    <input type="text" id="modal_respuesta_readonly" class="hidden w-full border-transparent bg-gray-100 text-gray-800 font-bold rounded-md p-2" disabled>
                </div>

                <div class="mb-2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Justificaci√≥n <span id="req_justification" class="text-red-500 hidden">*</span></label>
                    <textarea id="modal_justificacion" rows="4" class="w-full border-gray-300 rounded-md p-3 focus:ring-blue-500 focus:border-blue-500 text-sm resize-none disabled:bg-gray-100 disabled:text-gray-600 disabled:border-transparent" placeholder="Ingrese la justificaci√≥n de la decisi√≥n..."></textarea>
                </div>
            </div>

            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button onclick="closeResponseModal()" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition" id="btnCloseModal">Cancelar</button>
                <button onclick="saveRowResponse()" id="btnSaveModal" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">Guardar Respuesta</button>
            </div>
        </div>
    </div>

    <div id="bitacoraModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto w-[90%] max-w-3xl bg-white shadow-xl rounded-lg animate-[fade-in_0.2s_ease-out]">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">Bit√°cora de Solicitud</h3>
                <button onclick="document.getElementById('bitacoraModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="p-6"><table class="min-w-full divide-y divide-gray-300 border border-gray-200 rounded"><thead class="bg-gray-100"><tr><th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase">No. Solicitud</th><th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase">Fecha</th><th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase">Responsable</th><th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase">Estado</th><th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase">Acci√≥n</th></tr></thead><tbody id="bitacoraBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody></table></div>
            <div class="bg-gray-50 px-6 py-3 rounded-b-lg flex justify-end"><button onclick="document.getElementById('bitacoraModal').classList.add('hidden')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-bold">Cerrar</button></div>
        </div>
    </div>

    <footer class="bg-white border-t border-gray-200 mt-auto py-6">
        <div class="max-w-[1600px] mx-auto px-4 text-center">
            <a href="OVA.html" class="text-blue-600 hover:text-blue-800 font-medium text-sm transition-colors inline-flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Volver a los otros roles del mockup
            </a>
        </div>
    </footer>

<script>
// DATOS MOCK CON HISTORIAL (BIT√ÅCORA) INTEGRADO
        const mockRequests = [
            { 
                id: '45212025001', date: '2025-01-15', advCode: '4521', advId: '1.020.304.050', advName: 'Nathalia Rendon', 
                status: 'Pendiente', 
                assignedTo: 'M√≠', 
                lastUpdate: '2025-01-16',
                history: [
                    { date: '2025-01-15', actor: 'Asesor', action: 'Radicaci√≥n', status: 'Radicado' },
                ]
            },
            { 
                id: '88992025003', date: '2025-01-20', advCode: '8899', advId: '98.765.432', advName: 'Carlos Perez', 
                status: 'Devoluci√≥n', 
                assignedTo: 'Asesor', 
                lastUpdate: '2025-01-22',
                history: [
                    { date: '2025-01-20', actor: 'Asesor', action: 'Radicaci√≥n', status: 'Radicado' },
                    { date: '2025-01-22', actor: 'Jefe Regional', action: 'Devoluci√≥n por inconsistencia', status: 'Devoluci√≥n' }
                ]
            },
            { 
                id: '10102025005', date: '2025-02-05', advCode: '1010', advId: '1.111.222.333', advName: 'Maria Gomez', 
                status: 'Pendiente Gesti√≥n Humana', 
                assignedTo: 'Gesti√≥n Humana', 
                lastUpdate: '2025-02-06',
                history: [
                    { date: '2025-02-05', actor: 'Asesor', action: 'Radicaci√≥n', status: 'Radicado' },
                    { date: '2025-02-06', actor: 'Jefe Regional', action: 'Aprobaci√≥n inicial', status: 'Aprobado' }
                ]
            },
            { 
                id: '45212025006', date: '2025-02-06', advCode: '4521', advId: '1.020.304.050', advName: 'Nathalia Rendon', 
                status: 'Pendiente', 
                assignedTo: 'M√≠',
                lastUpdate: '2025-02-06',
                history: [
                    { date: '2025-02-06', actor: 'Asesor', action: 'Radicaci√≥n', status: 'Radicado' }
                ]
            }
        ];

        let mockDetails = [
            { requestId: '45212025001', rowId: 'r1', novedad: 'Comisi√≥n errada', plan: 'Familiar', programa: 'Oro', contrato: '100', usuario: 'Juan', motivoAsesor: 'Falta pago', respuestaJefe: '', justificacionJefe: '' },
            { requestId: '45212025001', rowId: 'r2', novedad: 'ACP - Acelerador', plan: 'Exequial', programa: 'Plata', contrato: '101', usuario: 'Ana', motivoAsesor: 'No aplica acelerador', respuestaJefe: '', justificacionJefe: '' }
        ];

        // INICIALIZACI√ìN: TABLA VAC√çA
        let currentRequests = []; 
        let currentPage = 1;
        let itemsPerPage = 5;
        let currentDetailRequestId = null;
        let hasSearched = false; 

        document.addEventListener('DOMContentLoaded', () => {
             renderDashboard(); 
        });

        // --- FUNCIONES DASHBOARD ---
        function applyFilters() {
            hasSearched = true;
            const fStatus = document.getElementById('filter_status').value;
            const fReqId = document.getElementById('filter_reqId').value.trim();
            const fAdvCode = document.getElementById('filter_advisorCode').value.trim();
            const fDateFrom = document.getElementById('filter_dateFrom').value;
            const fDateTo = document.getElementById('filter_dateTo').value;

            currentRequests = mockRequests.filter(req => {
                if (fStatus && req.status !== fStatus) return false;
                if (fReqId && !req.id.includes(fReqId)) return false;
                if (fAdvCode && !req.advCode.includes(fAdvCode)) return false;
                if (fDateFrom && new Date(req.date) < new Date(fDateFrom)) return false;
                if (fDateTo && new Date(req.date) > new Date(fDateTo)) return false;
                return true;
            });
            currentPage = 1;
            renderDashboard();
        }

        function clearFilters() {
            document.getElementById('filter_status').value = "Pendiente"; 
            document.getElementById('filter_reqId').value = "";
            document.getElementById('filter_advisorCode').value = "";
            document.getElementById('filter_dateFrom').value = "";
            document.getElementById('filter_dateTo').value = "";
            

        }

        function renderDashboard() {
            const body = document.getElementById('dashboardBody');
            body.innerHTML = "";

            if (!hasSearched) {
                body.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-gray-400 italic">Utilice los filtros y presione "Consultar" para ver resultados.</td></tr>`;
                document.getElementById('paginationControls').innerHTML = "";
                return;
            }

            if (currentRequests.length === 0) {
                body.innerHTML = `<tr><td colspan="8" class="text-center py-6 text-gray-500 italic">No se encontraron solicitudes con esos filtros.</td></tr>`;
                renderPagination(0);
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedData = currentRequests.slice(start, end);

            paginatedData.forEach(req => {
                const isLocked = req.status !== 'Pendiente'; 
                
                let badgeColor = "bg-gray-100 text-gray-800";
                if(req.status === 'Pendiente') badgeColor = "bg-yellow-100 text-yellow-800";
                if(req.status === 'Devoluci√≥n') badgeColor = "bg-orange-100 text-orange-800";
                if(req.status === 'Pendiente Gesti√≥n Humana') badgeColor = "bg-blue-100 text-blue-800"; // Nuevo estado visual
                if(req.status === 'Aprobado') badgeColor = "bg-green-100 text-green-800";
                if(req.status === 'Rechazado') badgeColor = "bg-red-100 text-red-800";

                const row = `
                    <tr class="hover:bg-gray-50 transition border-b border-gray-100">
                        <td class="px-6 py-4 whitespace-nowrap">${req.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-blue-600">${req.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${req.advCode}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${req.advName}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeColor}">${req.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500">${req.assignedTo}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500 text-xs">${req.lastUpdate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <div class="flex items-center justify-center gap-3">
                                <button onclick="loadDetails('${req.id}')" class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-1.5 rounded-full transition" title="${isLocked ? 'Ver Detalles' : 'Gestionar'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isLocked ? 'M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' : 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z'}" /></svg>
                                </button>
                                <button onclick="openBitacoraModal('${req.id}')" class="text-purple-600 hover:text-purple-800 hover:bg-purple-50 p-1.5 rounded-full transition" title="Ver Bit√°cora"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg></button>
                            </div>
                        </td>
                    </tr>
                `;
                body.insertAdjacentHTML('beforeend', row);
            });
            renderPagination(currentRequests.length);
        }

        // --- L√ìGICA DE FINALIZACI√ìN Y BIT√ÅCORA ---

        function finishManagement() {
            const rows = mockDetails.filter(d => d.requestId === currentDetailRequestId);
            if (rows.some(r => !r.respuestaJefe)) { alert("Debe gestionar todos los registros antes de finalizar."); return; }
            
            // L√≥gica de estados
            let visualStatus = "Pendiente Gesti√≥n Humana";
            let actionLog = "Aprobado por Jefe";
            let nextAssigned = "Gesti√≥n Humana";

            // Si hay devoluciones, todo se devuelve
            if (rows.some(r => r.respuestaJefe === 'Devoluci√≥n')) {
                visualStatus = "Devoluci√≥n";
                actionLog = "Devoluci√≥n por Jefe";
                nextAssigned = "Asesor";
            } 
            // Si todo es rechazado
            else if (rows.every(r => r.respuestaJefe === 'Rechazada')) {
                visualStatus = "Rechazado";
                actionLog = "Rechazo total por Jefe";
                nextAssigned = "Finalizado";
            }

            // Actualizar objeto
            const req = mockRequests.find(r => r.id === currentDetailRequestId);
            const today = new Date().toISOString().split('T')[0];
            
            req.status = visualStatus;
            req.lastUpdate = today;
            req.assignedTo = nextAssigned;

            // Agregar a la bit√°cora
            req.history.push({
                date: today,
                actor: 'Jefe Regional', 
                action: actionLog,
                status: visualStatus // Guardamos el estado resultante en la bit√°cora
            });

            alert(`Gesti√≥n finalizada exitosamente.\nEstado: ${visualStatus}`);
            showDashboard();
            applyFilters(); // Recargar tabla
        }

        function openBitacoraModal(reqId) {
            const req = mockRequests.find(r => r.id === reqId);
            const body = document.getElementById('bitacoraBody');
            body.innerHTML = "";

            if(req.history && req.history.length > 0) {
                req.history.forEach(h => {
                    body.insertAdjacentHTML('beforeend', `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-3 border-b text-gray-700 font-medium">${req.id}</td>
                            <td class="px-3 py-3 border-b text-gray-600">${h.date}</td>
                            <td class="px-3 py-3 border-b text-gray-600">${h.actor}</td>
                            <td class="px-3 py-3 border-b"><span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full border border-gray-200">${h.status}</span></td>
                            <td class="px-3 py-3 border-b text-gray-600 text-xs italic">${h.action}</td>
                        </tr>
                    `);
                });
            } else {
                body.innerHTML = "<tr><td colspan='5' class='text-center p-4 text-gray-500'>No hay historial disponible.</td></tr>";
            }
            document.getElementById('bitacoraModal').classList.remove('hidden');
        }

        // Resto de funciones auxiliares (renderPagination, changePageSize, exportToExcel, showDashboard, loadDetails, modals...)
        function changePageSize() { itemsPerPage = parseInt(document.getElementById('itemsPerPage').value); currentPage = 1; renderDashboard(); }
        function goToPage(page) { currentPage = page; renderDashboard(); }
        function renderPagination(totalItems) {
            const container = document.getElementById('paginationControls'); container.innerHTML = "";
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 1) return;
            container.innerHTML += `<button onclick="goToPage(${currentPage - 1})" class="px-3 py-1 border rounded text-xs hover:bg-gray-100 ${currentPage === 1 ? 'disabled-link' : ''}">&lt;</button>`;
            for (let i = 1; i <= totalPages; i++) container.innerHTML += `<button onclick="goToPage(${i})" class="pagination-btn px-3 py-1 border rounded text-xs mx-1 ${i === currentPage ? 'active' : 'bg-white'}">${i}</button>`;
            container.innerHTML += `<button onclick="goToPage(${currentPage + 1})" class="px-3 py-1 border rounded text-xs hover:bg-gray-100 ${currentPage === totalPages ? 'disabled-link' : ''}">&gt;</button>`;
        }
        function exportToExcel() {
            if(currentRequests.length === 0) { alert("No hay datos filtrados para exportar."); return; }
            const ws = XLSX.utils.json_to_sheet(currentRequests);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Solicitudes");
            XLSX.writeFile(wb, "Reporte.xlsx");
        }
        function showDashboard() { document.getElementById('viewDetail').classList.add('hidden'); document.getElementById('viewDashboard').classList.remove('hidden'); }
        function showAttachments() { alert("üìé Mostrando modal con adjuntos..."); }
        function loadDetails(reqId) {
            currentDetailRequestId = reqId;
            const req = mockRequests.find(r => r.id === reqId);
            document.getElementById('detail_reqId').innerText = req.id;
            document.getElementById('detail_advCode').innerText = req.advCode;
            document.getElementById('detail_advId').innerText = req.advId;
            document.getElementById('detail_advName').innerText = req.advName;
            document.getElementById('detail_date').innerText = req.date;
            
            // Bot√≥n finalizar solo visible si est√° Pendiente
            const btnFinish = document.getElementById('btnFinishContainer'); 
            if (req.status === 'Pendiente') btnFinish.classList.remove('hidden'); 
            else btnFinish.classList.add('hidden');

            renderDetailTable();
            document.getElementById('viewDashboard').classList.add('hidden');
            document.getElementById('viewDetail').classList.remove('hidden');
            document.getElementById('viewDetail').classList.add('flex');
        }
        function renderDetailTable() {
            const body = document.getElementById('detailsBody'); body.innerHTML = "";
            const rows = mockDetails.filter(d => d.requestId === currentDetailRequestId);
            rows.forEach(row => {
                let statusColor = "text-gray-400"; let statusText = "Sin Gestionar"; let actionBtn = "";
                if (row.respuestaJefe) {
                    if (row.respuestaJefe === 'Aprobada') { statusColor = "text-green-600 font-bold"; statusText = "Aprobada"; }
                    if (row.respuestaJefe === 'Rechazada') { statusColor = "text-red-600 font-bold"; statusText = "Rechazada"; }
                    if (row.respuestaJefe === 'Devoluci√≥n') { statusColor = "text-orange-600 font-bold"; statusText = "Devoluci√≥n"; }
                    actionBtn = `<button onclick="openResponseModal('${row.rowId}', 'view')" class="text-blue-600 font-bold text-xs">Ver Detalle</button>`;
                } else {
                    actionBtn = `<button onclick="openResponseModal('${row.rowId}', 'edit')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold w-full">Responder</button>`;
                }
                body.insertAdjacentHTML('beforeend', `<tr class="hover:bg-gray-50 text-sm"><td class="px-4 py-3 border-r">${row.novedad}</td><td class="px-4 py-3 border-r">${row.plan}</td><td class="px-4 py-3 border-r">${row.programa}</td><td class="px-4 py-3 border-r">${row.contrato}</td><td class="px-4 py-3 border-r">${row.usuario}</td><td class="px-4 py-3 border-r italic">"${row.motivoAsesor}"</td><td class="px-4 py-3 border-r text-center ${statusColor}">${statusText}</td><td class="px-4 py-3 text-center">${actionBtn}</td></tr>`);
            });
        }
        // Funciones del modal de respuesta 
        function openResponseModal(rowId, mode) {
            const row = mockDetails.find(r => r.rowId === rowId);
            document.getElementById('modal_rowId').value = rowId;
            const display = document.getElementById('modal_novedad_display');
            const select = document.getElementById('modal_novedad_select');
            const justif = document.getElementById('modal_justificacion');
            const respSelect = document.getElementById('modal_respuesta');
            const respRead = document.getElementById('modal_respuesta_readonly');
            
            display.value = row.novedad;
            Array.from(select.options).forEach(opt => { if(row.novedad.includes(opt.value.substring(0,3))) select.value = opt.value; });
            display.classList.remove('hidden'); select.classList.add('hidden');
            justif.value = row.justificacionJefe || "";
            
            if (mode === 'view') {
                document.getElementById('modalTitle').innerText = "Detalle de Respuesta";
                document.getElementById('btnEditNovedad').classList.add('hidden');
                document.getElementById('btnSaveModal').classList.add('hidden');
                respSelect.classList.add('hidden'); respRead.classList.remove('hidden');
                respRead.value = row.respuestaJefe; justif.disabled = true;
            } else {
                document.getElementById('modalTitle').innerText = "Responder Reclamaci√≥n";
                document.getElementById('btnEditNovedad').classList.remove('hidden');
                document.getElementById('btnSaveModal').classList.remove('hidden');
                respSelect.classList.remove('hidden'); respRead.classList.add('hidden');
                respSelect.value = row.respuestaJefe || ""; justif.disabled = false;
                toggleJustification();
            }
            document.getElementById('responseModal').classList.remove('hidden');
        }
        function closeResponseModal() { document.getElementById('responseModal').classList.add('hidden'); }
        function toggleNovedadEdit() { const d = document.getElementById('modal_novedad_display'), s = document.getElementById('modal_novedad_select'); d.classList.toggle('hidden'); s.classList.toggle('hidden'); }
        function toggleJustification() { const v = document.getElementById('modal_respuesta').value, l = document.getElementById('req_justification'); if(v==='Rechazada'||v==='Devoluci√≥n') l.classList.remove('hidden'); else l.classList.add('hidden'); }
        function saveRowResponse() {
            const rowId = document.getElementById('modal_rowId').value;
            const res = document.getElementById('modal_respuesta').value;
            const jus = document.getElementById('modal_justificacion').value.trim();
            const novSel = document.getElementById('modal_novedad_select');
            if (!res) { alert("Respuesta obligatoria"); return; }
            if ((res === 'Rechazada' || res === 'Devoluci√≥n') && !jus) { alert("Justificaci√≥n obligatoria"); return; }
            const row = mockDetails.find(r => r.rowId === rowId);
            row.respuestaJefe = res; row.justificacionJefe = jus;
            if (document.getElementById('modal_novedad_display').classList.contains('hidden')) row.novedad = novSel.value;
            closeResponseModal(); renderDetailTable();
        }
    </script>
</body>
</html>